name: Build and deploy static site to GitHub Pages

on:
  push:
    branches: [ master ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v3
      with:
        php-version: '8.1'

    - name: Start PHP built-in server
      run: |
        php -S 127.0.0.1:8001 -t web >/tmp/php-server.log 2>&1 &
        for i in {1..15}; do
          if curl -sSf http://127.0.0.1:8001/ >/dev/null; then
            echo "PHP server ready"; break
          fi
          sleep 1
        done

    - name: Generate static files with wget
      run: |
        sudo apt-get update && sudo apt-get install -y wget
        rm -rf static_site
        mkdir -p static_site
        # Mirror the site served by local PHP server into static_site/
        wget --mirror --convert-links --adjust-extension --page-requisites --no-parent \
          --no-host-directories --directory-prefix=static_site -e robots=off --span-hosts http://127.0.0.1:8001/
        # If wget created host subdir (e.g. static_site/127.0.0.1:8001), move files up
        if [ -d static_site/127.0.0.1:8001 ]; then
          mv static_site/127.0.0.1:8001/* static_site/ || true
          rmdir static_site/127.0.0.1:8001 || true
        fi
        # Ensure GitHub Pages serves files as-is
        touch static_site/.nojekyll

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./static_site
