name: Build and deploy static site to GitHub Pages

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: {}

concurrency:
  group: build-and-deploy-static-site
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v3
      with:
        php-version: '8.1'

    - name: Start PHP built-in server
      run: |
        php -S 127.0.0.1:8001 -t web >/tmp/php-server.log 2>&1 &
        for i in {1..15}; do
          if curl -sSf http://127.0.0.1:8001/ >/dev/null; then
            echo "PHP server ready"; break
          fi
          sleep 1
        done

    - name: Generate static files with script
      run: |
        sudo apt-get update && sudo apt-get install -y wget curl
        rm -rf static_site
        mkdir -p static_site
        chmod +x ./scripts/generate_static.sh
        # By default we do NOT span hosts. If you need to exclude some external domains
        # while allowing others, pass a comma-separated list as the 2nd argument.
        # Here we explicitly exclude common external hosts to avoid 3rd-party fetches.
        ./scripts/generate_static.sh 8001 "acm.org,libraries.acm.org,fonts.googleapis.com,fonts.gstatic.com,cdn.jsdelivr.net"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./static_site
        # keep the history small on gh-pages
        keep_files: false
